# ============================================================
# Pre-commit configuration
# - Atomic commits with conventional commits
# - Formatting, linting, static analysis, security, docs
# ============================================================

repos:
  # -------------------------
  # Quick sanity checks (fast, fail early)
  # -------------------------
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      # Remove trailing whitespace
      - id: trailing-whitespace
        exclude: ^(docs/_build/|node_modules)
      # Ensure files end with a newline
      - id: end-of-file-fixer
        exclude: ^(docs/_build/|node_modules)
      # Validate YAML files
      - id: check-yaml
      # Prevent accidentally adding large files
      - id: check-added-large-files
        exclude: ^node_modules/

  # -------------------------
  # Code formatting
  # -------------------------
  - repo: https://github.com/psf/black
    rev: 26.1.0
    hooks:
      # Automatically format Python files using Black
      - id: black
        exclude: '^\.venv/'

  - repo: https://github.com/pre-commit/mirrors-isort
    rev: v5.10.1
    hooks:
      # Automatically sort Python imports
      - id: isort
        exclude: '^\.venv/'

  - repo: https://github.com/pre-commit/mirrors-prettier
    rev: v4.0.0-alpha.8
    hooks:
      # Format JSON, YAML, Markdown, JS/TS files
      - id: prettier
        files: \.(json|yml|yaml|md|js|ts)$
        exclude: '(^\.venv/|^node_modules/|^docs/_build/)'

  # -------------------------
  # Lightweight linting & typing
  # -------------------------
  - repo: https://github.com/PyCQA/flake8
    rev: 7.3.0
    hooks:
      # Python code linter
      - id: flake8
        exclude: '^\.venv/'

  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.19.1
    hooks:
      # Type checker for Python
      - id: mypy
        exclude: '^\.venv/'

  # -------------------------
  # Pylint (runs on root or src)
  # -------------------------
  - repo: https://github.com/PyCQA/pylint
    rev: v4.0.4
    hooks:
      - id: pylint
        additional_dependencies:
          - setuptools>=68
          - wheel
        # Only run on root or src directories
        files: ^(\.|src)/

  # -------------------------
  # Heavier static analysis (local)
  # -------------------------
  - repo: local
    hooks:
      # Cyclomatic complexity check using Radon
      - id: radon-cc
        name: Check Cyclomatic Complexity with Radon
        entry: poetry run radon cc .
        language: system
        args:
          - --min
          - C
          - -s
          - -a
          - --exclude
          - "venv,.venv,build,dist,.mypy_cache,.pytest_cache"
        pass_filenames: false

      - id: vulture
        name: Detect unused code with Vulture
        entry: poetry run vulture
        language: system
        pass_filenames: false
        args:
          - --exclude
          - docs/,docs/conf.py,venv,.venv,build,dist,.mypy_cache,.pytest_cache,.pre-commit-config.yaml
          - .

  # -------------------------
  # Security scanning
  # -------------------------
  - repo: https://github.com/PyCQA/bandit
    rev: 1.9.3
    hooks:
      - id: bandit
        args:
          - "-r"
          - "."
          - "-x"
          - ".venv,venv,build,dist,.mypy_cache,.pytest_cache"
        pass_filenames: false

  # -------------------------
  # Local environment & documentation
  # -------------------------
  - repo: local
    hooks:
      # Block committing .env files (security)
      - id: block-env-files
        name: Block .env files
        language: python
        entry: hooks/block_env.py
        files: (^|/)\.env(\.[a-zA-Z0-9_-]+|$)

      # Build Sphinx documentation
      - id: build-sphinx
        name: Build Sphinx docs
        entry: poetry run python -m sphinx -b html docs docs/_build/html
        language: system
        pass_filenames: false
        files: \.(rst|md)$
        exclude: ^(\.venv|venv|\.mypy_cache|\.pytest_cache|build|dist)/

      # Lint commit messages (Windows-compatible)
      - id: commitlint
        name: Lint commit messages
        entry: bash -c 'npx commitlint --edit "$1"' --
        language: system
        stages: [commit-msg]
