# ============================================================
# Pre-commit configuration
# - Atomic commits with conventional commits
# - Formatting, linting, static analysis, security, docs
# ============================================================

repos:
  # -------------------------
  # Quick sanity checks (fast, fail early)
  # -------------------------
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: trailing-whitespace
        exclude: ^(docs/_build/|node_modules)
      - id: end-of-file-fixer
        exclude: ^(docs/_build/|node_modules)
      - id: check-yaml
      - id: check-added-large-files
        exclude: ^node_modules/

  # -------------------------
  # Code formatting
  # -------------------------
  - repo: https://github.com/psf/black
    rev: 26.1.0
    hooks:
      - id: black
        exclude: '^\.venv/'

  - repo: https://github.com/pre-commit/mirrors-isort
    rev: v5.10.1
    hooks:
      - id: isort
        exclude: '^\.venv/'

  - repo: https://github.com/pre-commit/mirrors-prettier
    rev: v4.0.0-alpha.8
    hooks:
      - id: prettier
        files: \.(json|yml|yaml|md|js|ts)$
        exclude: '(^\.venv/|^node_modules/|^docs/_build/)'

  # -------------------------
  # Lightweight linting & typing
  # -------------------------
  - repo: https://github.com/PyCQA/flake8
    rev: 7.3.0
    hooks:
      - id: flake8
        exclude: '^\.venv/'

  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.19.1
    hooks:
      - id: mypy
        exclude: '^\.venv/'

  # -------------------------
  # Pylint (runs on root or src)
  # -------------------------
  - repo: https://github.com/PyCQA/pylint
    rev: v4.0.4
    hooks:
      - id: pylint
        additional_dependencies:
          - setuptools>=68
          - wheel
        files: ^(\.|src)/

  # -------------------------
  # Heavier static analysis (local)
  # -------------------------
  - repo: local
    hooks:
      - id: radon-cc
        name: Check Cyclomatic Complexity with Radon
        entry: poetry run radon cc .
        language: system
        args:
          - --min
          - C
          - -s
          - -a
          - --exclude
          - "venv,.venv,build,dist,.mypy_cache,.pytest_cache"
        pass_filenames: false

      - id: vulture
        name: Detect unused code with Vulture
        entry: python hooks/vulture-wrapper.py
        language: system
        pass_filenames: true
        types: [python]
        args:
          - --exclude
          - docs/,docs/conf.py,venv,.venv,build,dist,.mypy_cache,.pytest_cache,.pre-commit-config.yaml
          - --ignore-names
          - read_root,create_item,update_item,delete_item

  # -------------------------
  # Security scanning
  # -------------------------
  - repo: https://github.com/PyCQA/bandit
    rev: 1.9.3
    hooks:
      - id: bandit
        args:
          - "-r"
          - "."
          - "-x"
          - ".venv,venv,build,dist,.mypy_cache,.pytest_cache,tests"
        pass_filenames: false

  # -------------------------
  # Local environment & documentation
  # -------------------------
  - repo: local
    hooks:
      - id: block-env-files
        name: Block .env files
        language: python
        entry: hooks/block_env.py
        files: (^|/)\.env(\.[a-zA-Z0-9_-]+|$)

      - id: build-sphinx
        name: Build Sphinx docs
        entry: poetry run python -m sphinx -b html docs docs/_build/html
        language: system
        pass_filenames: false
        files: \.(rst|md)$
        exclude: ^(\.venv|venv|\.mypy_cache|\.pytest_cache|build|dist)/

      - id: commitlint
        name: Lint commit messages
        entry: bash -c 'npx commitlint --edit "$1"' --
        language: system
        stages: [commit-msg]

  # -------------------------
  # Docker & container checks
  # -------------------------

  # Lint Dockerfiles for common errors.

  - repo: https://github.com/hadolint/hadolint
    rev: v2.12.0
    hooks:
      - id: hadolint
        files: ^Dockerfile$

  # Lints docker-compose.yaml files for errors and service issues

  - repo: local
    hooks:
      - id: compose-lint
        name: Lint docker-compose files
        entry: docker-compose-linter check docker-compose.yml
        language: system
        files: ^(docker-)?compose\.ya?ml$
        stages: [pre-commit]

  # Detect secrets in .env, Dockerfile, and YAML files
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.3.0
    hooks:
      - id: detect-secrets
        files: \.(env|Dockerfile|yml|yaml)$
        stages: [pre-commit]

  # Local hooks for heavier Docker-related checks
  - repo: local
    hooks:
      - id: trivy-scan-image
        name: Scan Docker image for OS vulnerabilities
        entry: trivy image --severity HIGH,CRITICAL my-image:latest
        language: system
        pass_filenames: false
        stages: [pre-push] # Scans the built Docker image before pushing
        # Notes:
        # - HIGH,CRITICAL filters only high-risk CVEs
        # - Using pre-push stage avoids slowing down every commit
        # - 'my-image:latest' should match the latest built Docker image tag

      - id: trivy-scan-deps
        name: Scan Python dependencies in Docker image
        entry: trivy fs --severity HIGH,CRITICAL --scanners vuln poetry.lock
        language: system
        pass_filenames: false
        stages: [pre-push] # scan dependencies before pushing image

      - id: cosign-sign
        name: Sign Docker image with Cosign
        entry: cosign sign --key cosign.key my-image:latest
        language: system
        pass_filenames: false
        stages: [pre-push]
        # Cryptographically signs the Docker image to ensure integrity before pushing
