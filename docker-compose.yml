# ========================================================
# docker-compose.yml for poetry-pipeline
# ========================================================

name: poetry-pipeline
services:
  api:
    build: . # Build container from local Dockerfile
    container_name: fastapi_app # Friendly container name
    environment:
      ENVIRONMENT: production # Matches Dockerfile production setting
    ports:
      - "${PORT:-8000}:8000"
    networks:
      - internal # Internal network for isolation
    restart: unless-stopped # Keep container alive if it crashes
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      retries: 3

    # ---------------------------
    # Logging (observability)
    # ---------------------------
    logging:
      driver: "json-file"
      options:
        max-size: "10m" # Rotate logs at 10MB
        max-file: "3" # Keep last 3 rotated logs

    # ---------------------------
    # Resource limits / fault control
    # ---------------------------
    deploy:
      resources:
        limits:
          cpus: "0.5" # Hard caps to prevent runaway usage
          memory: 256M
        reservations:
          cpus: "0.25" # Minimum guaranteed resources
          memory: 128M
    read_only: true # Read-only filesystem for security
    tmpfs: /tmp # Writable temp space for runtime needs
    ulimits:
      nproc: 100
      nofile:
        soft: 1024
        hard: 2048

# ========================================================
# Internal network definition
# ========================================================
networks:
  internal:
    driver: bridge
